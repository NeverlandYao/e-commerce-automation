# ç”µå•†AIè‡ªåŠ¨åŒ–å¹³å° - æŠ€æœ¯æ¶æ„è®¾è®¡

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### åˆ†å±‚æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è¡¨ç°å±‚ (Presentation Layer)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Web Console   â”‚  â”‚   Mobile App    â”‚  â”‚   API Gateway   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     ä¸šåŠ¡å±‚ (Business Layer)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Workflow Engine â”‚  â”‚  Task Scheduler â”‚  â”‚ Plugin Manager  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     æœåŠ¡å±‚ (Service Layer)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Scraper Service â”‚  â”‚   AI Service    â”‚  â”‚ Publisher Svc   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     æ•°æ®å±‚ (Data Layer)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   PostgreSQL    â”‚  â”‚      Redis      â”‚  â”‚   File Storage  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æŠ€æœ¯æ ˆé€‰å‹

### åç«¯æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|----------|------|------|
| è¿è¡Œæ—¶ | Node.js | 18+ | é«˜æ€§èƒ½JavaScriptè¿è¡Œæ—¶ |
| Webæ¡†æ¶ | Express.js | 4.18+ | è½»é‡çº§Webæ¡†æ¶ |
| çˆ¬è™«å¼•æ“ | Playwright | 1.40+ | ç°ä»£åŒ–æµè§ˆå™¨è‡ªåŠ¨åŒ– |
| æ•°æ®åº“ | PostgreSQL | 14+ | å…³ç³»å‹æ•°æ®åº“ |
| ç¼“å­˜ | Redis | 7+ | å†…å­˜æ•°æ®åº“ |
| æ¶ˆæ¯é˜Ÿåˆ— | Bull Queue | 4+ | Redis-basedé˜Ÿåˆ— |
| ORM | Prisma | 5+ | ç°ä»£åŒ–æ•°æ®åº“å·¥å…· |
| æ—¥å¿— | Winston | 3+ | æ—¥å¿—ç®¡ç† |
| æµ‹è¯• | Jest | 29+ | æµ‹è¯•æ¡†æ¶ |

### å‰ç«¯æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|----------|------|------|
| æ¡†æ¶ | React | 18+ | ç”¨æˆ·ç•Œé¢åº“ |
| çŠ¶æ€ç®¡ç† | Zustand | 4+ | è½»é‡çº§çŠ¶æ€ç®¡ç† |
| è·¯ç”± | React Router | 6+ | å®¢æˆ·ç«¯è·¯ç”± |
| UIç»„ä»¶ | Ant Design | 5+ | ä¼ä¸šçº§UIç»„ä»¶åº“ |
| å›¾è¡¨ | ECharts | 5+ | æ•°æ®å¯è§†åŒ– |
| æ„å»ºå·¥å…· | Vite | 5+ | ç°ä»£åŒ–æ„å»ºå·¥å…· |
| CSSæ¡†æ¶ | Tailwind CSS | 3+ | å®ç”¨ä¼˜å…ˆçš„CSSæ¡†æ¶ |

### åŸºç¡€è®¾æ–½

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|----------|------|
| å®¹å™¨åŒ– | Docker | åº”ç”¨å®¹å™¨åŒ– |
| ç¼–æ’ | Docker Compose | æœ¬åœ°å¼€å‘ç¯å¢ƒ |
| åå‘ä»£ç† | Nginx | è´Ÿè½½å‡è¡¡å’Œé™æ€æ–‡ä»¶æœåŠ¡ |
| ç›‘æ§ | Prometheus + Grafana | ç³»ç»Ÿç›‘æ§å’Œå¯è§†åŒ– |
| æ—¥å¿—æ”¶é›† | ELK Stack | æ—¥å¿—èšåˆå’Œåˆ†æ |

## ğŸ”Œ æ’ä»¶ç³»ç»Ÿæ¶æ„

### æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†

```javascript
class PluginManager {
  constructor() {
    this.plugins = new Map();
    this.hooks = new Map();
    this.eventBus = new EventEmitter();
  }

  // æ’ä»¶æ³¨å†Œ
  async register(pluginConfig) {
    const plugin = await this.loadPlugin(pluginConfig);
    await plugin.initialize();
    this.plugins.set(plugin.name, plugin);
    this.registerHooks(plugin);
    this.eventBus.emit('plugin:registered', plugin);
  }

  // æ’ä»¶å¸è½½
  async unregister(pluginName) {
    const plugin = this.plugins.get(pluginName);
    if (plugin) {
      await plugin.destroy();
      this.plugins.delete(pluginName);
      this.unregisterHooks(plugin);
      this.eventBus.emit('plugin:unregistered', plugin);
    }
  }

  // æ‰§è¡Œé’©å­
  async executeHook(hookName, context) {
    const hooks = this.hooks.get(hookName) || [];
    const results = [];
    
    for (const hook of hooks) {
      try {
        const result = await hook.execute(context);
        results.push(result);
      } catch (error) {
        console.error(`Hook ${hookName} execution failed:`, error);
      }
    }
    
    return results;
  }
}
```

### æ’ä»¶æ¥å£å®šä¹‰

```typescript
// çˆ¬è™«æ’ä»¶æ¥å£
interface IScraperPlugin {
  name: string;
  version: string;
  supportedDomains: string[];
  
  initialize(): Promise<void>;
  destroy(): Promise<void>;
  
  scrapeProduct(url: string): Promise<Product>;
  scrapeCategory(categoryUrl: string, options?: ScrapeOptions): Promise<Product[]>;
  searchProducts(keyword: string, options?: SearchOptions): Promise<Product[]>;
  
  validateProduct(product: Product): Promise<boolean>;
  login?(credentials: LoginCredentials): Promise<boolean>;
}

// å‘å¸ƒæ’ä»¶æ¥å£
interface IPublisherPlugin {
  name: string;
  version: string;
  platform: string;
  
  initialize(): Promise<void>;
  destroy(): Promise<void>;
  
  authenticate(): Promise<boolean>;
  publishProduct(product: Product): Promise<PublishResult>;
  updateProduct(productId: string, product: Product): Promise<UpdateResult>;
  deleteProduct(productId: string): Promise<DeleteResult>;
  
  getProductStatus(productId: string): Promise<ProductStatus>;
  validateProductData(product: Product): Promise<ValidationResult>;
}

// AIåˆ†ææ’ä»¶æ¥å£
interface IAnalyzerPlugin {
  name: string;
  version: string;
  
  initialize(): Promise<void>;
  destroy(): Promise<void>;
  
  analyzeProducts(products: Product[]): Promise<AnalysisResult[]>;
  predictTrend(product: Product): Promise<TrendPrediction>;
  optimizeProduct(product: Product): Promise<OptimizationSuggestion>;
  
  calculateScore(product: Product, criteria: AnalysisCriteria): Promise<number>;
}
```

## ğŸ”„ å·¥ä½œæµå¼•æ“è®¾è®¡

### å·¥ä½œæµæ‰§è¡Œå¼•æ“

```javascript
class WorkflowEngine {
  constructor(pluginManager, taskScheduler) {
    this.pluginManager = pluginManager;
    this.taskScheduler = taskScheduler;
    this.executionContext = new Map();
  }

  async executeWorkflow(workflowConfig, initialData = {}) {
    const execution = {
      id: generateId(),
      workflowId: workflowConfig.id,
      status: 'running',
      startTime: new Date(),
      currentStep: null,
      data: initialData,
      results: {},
      errors: []
    };

    this.executionContext.set(execution.id, execution);

    try {
      for (const step of workflowConfig.steps) {
        execution.currentStep = step.id;
        
        // æ£€æŸ¥æ‰§è¡Œæ¡ä»¶
        if (step.condition && !this.evaluateCondition(step.condition, execution.data)) {
          continue;
        }

        // æ‰§è¡Œæ­¥éª¤
        const result = await this.executeStep(step, execution.data);
        execution.results[step.id] = result;
        
        // æ›´æ–°æ‰§è¡Œæ•°æ®
        if (step.outputMapping) {
          this.mapOutput(step.outputMapping, result, execution.data);
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è½¬
        if (step.next) {
          const nextStepId = this.resolveNextStep(step.next, result);
          if (nextStepId === 'end') break;
        }
      }

      execution.status = 'completed';
      execution.endTime = new Date();
      
    } catch (error) {
      execution.status = 'failed';
      execution.errors.push(error.message);
      execution.endTime = new Date();
      
      // æ‰§è¡Œé”™è¯¯å¤„ç†
      await this.handleWorkflowError(execution, error);
    }

    return execution;
  }

  async executeStep(step, data) {
    const handler = this.getStepHandler(step.type);
    if (!handler) {
      throw new Error(`Unknown step type: ${step.type}`);
    }

    const context = {
      stepId: step.id,
      config: step.config,
      data: data,
      pluginManager: this.pluginManager
    };

    return await handler.execute(context);
  }

  getStepHandler(stepType) {
    const handlers = {
      'scraper': new ScraperStepHandler(),
      'analyzer': new AnalyzerStepHandler(),
      'price_checker': new PriceCheckerStepHandler(),
      'publisher': new PublisherStepHandler(),
      'condition': new ConditionStepHandler(),
      'parallel': new ParallelStepHandler()
    };

    return handlers[stepType];
  }
}
```

### æ­¥éª¤å¤„ç†å™¨å®ç°

```javascript
class ScraperStepHandler {
  async execute(context) {
    const { config, data, pluginManager } = context;
    const results = [];

    for (const pluginName of config.plugins) {
      const plugin = pluginManager.getPlugin(pluginName);
      if (!plugin) continue;

      try {
        let products = [];
        
        if (config.keywords) {
          for (const keyword of config.keywords) {
            const searchResults = await plugin.searchProducts(keyword, config.searchOptions);
            products.push(...searchResults);
          }
        }

        if (config.categories) {
          for (const categoryUrl of config.categories) {
            const categoryResults = await plugin.scrapeCategory(categoryUrl, config.scrapeOptions);
            products.push(...categoryResults);
          }
        }

        // åº”ç”¨è¿‡æ»¤å™¨
        if (config.filters) {
          products = this.applyFilters(products, config.filters);
        }

        results.push({
          plugin: pluginName,
          products: products,
          count: products.length
        });

      } catch (error) {
        console.error(`Scraper plugin ${pluginName} failed:`, error);
        results.push({
          plugin: pluginName,
          error: error.message,
          products: [],
          count: 0
        });
      }
    }

    return {
      totalProducts: results.reduce((sum, r) => sum + r.count, 0),
      results: results,
      products: results.flatMap(r => r.products)
    };
  }

  applyFilters(products, filters) {
    return products.filter(product => {
      if (filters.minSales && product.salesCount < filters.minSales) return false;
      if (filters.minRating && product.rating < filters.minRating) return false;
      if (filters.maxPrice && product.price > filters.maxPrice) return false;
      if (filters.minPrice && product.price < filters.minPrice) return false;
      return true;
    });
  }
}

class AnalyzerStepHandler {
  async execute(context) {
    const { config, data, pluginManager } = context;
    const products = data.products || [];
    
    if (products.length === 0) {
      return { analyzedProducts: [], topProducts: [] };
    }

    const analyzerPlugin = pluginManager.getPlugin(config.plugin);
    if (!analyzerPlugin) {
      throw new Error(`Analyzer plugin ${config.plugin} not found`);
    }

    // æ‰§è¡ŒAIåˆ†æ
    const analysisResults = await analyzerPlugin.analyzeProducts(products);
    
    // è®¡ç®—ç»¼åˆå¾—åˆ†
    const scoredProducts = products.map((product, index) => {
      const analysis = analysisResults[index];
      const score = this.calculateCompositeScore(analysis, config.criteria);
      
      return {
        ...product,
        analysis: analysis,
        score: score
      };
    });

    // æ’åºå¹¶é€‰æ‹©Top N
    const topProducts = scoredProducts
      .sort((a, b) => b.score - a.score)
      .slice(0, config.topN || 50);

    return {
      analyzedProducts: scoredProducts,
      topProducts: topProducts,
      totalAnalyzed: products.length,
      averageScore: scoredProducts.reduce((sum, p) => sum + p.score, 0) / scoredProducts.length
    };
  }

  calculateCompositeScore(analysis, criteria) {
    let score = 0;
    
    if (criteria.salesTrend) {
      score += analysis.salesTrendScore * criteria.salesTrend;
    }
    
    if (criteria.profitMargin) {
      score += analysis.profitMarginScore * criteria.profitMargin;
    }
    
    if (criteria.competition) {
      score += analysis.competitionScore * criteria.competition;
    }
    
    if (criteria.marketDemand) {
      score += analysis.marketDemandScore * criteria.marketDemand;
    }

    return Math.min(Math.max(score, 0), 100); // é™åˆ¶åœ¨0-100ä¹‹é—´
  }
}
```

## ğŸ—„ï¸ æ•°æ®æ¶æ„è®¾è®¡

### æ•°æ®åº“Schemaè®¾è®¡

```sql
-- å•†å“è¡¨
CREATE TABLE products (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(500) NOT NULL,
    description TEXT,
    price DECIMAL(12,2),
    original_price DECIMAL(12,2),
    currency VARCHAR(3) DEFAULT 'CNY',
    images JSONB,
    specifications JSONB,
    source_platform VARCHAR(50) NOT NULL,
    source_url VARCHAR(1000),
    source_id VARCHAR(100),
    category_id UUID REFERENCES categories(id),
    brand VARCHAR(100),
    sales_count INTEGER DEFAULT 0,
    rating DECIMAL(3,2),
    review_count INTEGER DEFAULT 0,
    tags TEXT[],
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•
    INDEX idx_products_source (source_platform, source_id),
    INDEX idx_products_category (category_id),
    INDEX idx_products_status (status),
    INDEX idx_products_created (created_at),
    INDEX idx_products_price (price),
    INDEX idx_products_rating (rating)
);

-- åˆ†ç±»è¡¨
CREATE TABLE categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(200) NOT NULL,
    slug VARCHAR(200) UNIQUE,
    parent_id UUID REFERENCES categories(id),
    level INTEGER DEFAULT 0,
    path VARCHAR(500), -- åˆ†ç±»è·¯å¾„ï¼Œå¦‚ "/electronics/phones/smartphones"
    description TEXT,
    image_url VARCHAR(500),
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_categories_parent (parent_id),
    INDEX idx_categories_path (path),
    INDEX idx_categories_slug (slug)
);

-- AIåˆ†æç»“æœè¡¨
CREATE TABLE ai_analysis (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    product_id UUID REFERENCES products(id) ON DELETE CASCADE,
    analyzer_plugin VARCHAR(50) NOT NULL,
    analysis_type VARCHAR(50) NOT NULL,
    score DECIMAL(5,2),
    confidence DECIMAL(3,2), -- ç½®ä¿¡åº¦
    insights JSONB, -- åˆ†ææ´å¯Ÿ
    recommendations JSONB, -- æ¨èå»ºè®®
    market_trend JSONB, -- å¸‚åœºè¶‹åŠ¿
    competition_analysis JSONB, -- ç«äº‰åˆ†æ
    profit_analysis JSONB, -- åˆ©æ¶¦åˆ†æ
    risk_assessment JSONB, -- é£é™©è¯„ä¼°
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_ai_analysis_product (product_id),
    INDEX idx_ai_analysis_type (analysis_type),
    INDEX idx_ai_analysis_score (score),
    INDEX idx_ai_analysis_created (created_at)
);

-- ä»·æ ¼æ¯”è¾ƒè¡¨
CREATE TABLE price_comparisons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    product_id UUID REFERENCES products(id) ON DELETE CASCADE,
    supplier_platform VARCHAR(50) NOT NULL,
    supplier_name VARCHAR(200),
    supplier_id VARCHAR(100),
    supplier_url VARCHAR(1000),
    supplier_price DECIMAL(12,2) NOT NULL,
    shipping_cost DECIMAL(12,2) DEFAULT 0,
    total_cost DECIMAL(12,2) GENERATED ALWAYS AS (supplier_price + shipping_cost) STORED,
    profit_margin DECIMAL(5,2),
    quality_score DECIMAL(3,2),
    delivery_time INTEGER, -- å‘è´§æ—¶é—´ï¼ˆå¤©ï¼‰
    minimum_order_quantity INTEGER DEFAULT 1,
    supplier_rating DECIMAL(3,2),
    supplier_reviews INTEGER DEFAULT 0,
    is_recommended BOOLEAN DEFAULT false,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_price_comparisons_product (product_id),
    INDEX idx_price_comparisons_platform (supplier_platform),
    INDEX idx_price_comparisons_price (supplier_price),
    INDEX idx_price_comparisons_margin (profit_margin),
    INDEX idx_price_comparisons_recommended (is_recommended)
);

-- å‘å¸ƒè®°å½•è¡¨
CREATE TABLE publish_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    product_id UUID REFERENCES products(id) ON DELETE CASCADE,
    target_platform VARCHAR(50) NOT NULL,
    platform_product_id VARCHAR(100),
    platform_url VARCHAR(1000),
    publish_status VARCHAR(20) DEFAULT 'pending', -- pending, published, failed, updated, deleted
    publish_data JSONB, -- å‘å¸ƒæ—¶çš„å•†å“æ•°æ®
    optimization_applied JSONB, -- åº”ç”¨çš„ä¼˜åŒ–
    error_message TEXT,
    retry_count INTEGER DEFAULT 0,
    last_sync_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_publish_records_product (product_id),
    INDEX idx_publish_records_platform (target_platform),
    INDEX idx_publish_records_status (publish_status),
    INDEX idx_publish_records_platform_id (target_platform, platform_product_id)
);

-- å·¥ä½œæµæ‰§è¡Œè®°å½•è¡¨
CREATE TABLE workflow_executions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workflow_id VARCHAR(100) NOT NULL,
    workflow_name VARCHAR(200),
    status VARCHAR(20) DEFAULT 'running', -- running, completed, failed, cancelled
    trigger_type VARCHAR(50), -- manual, scheduled, webhook
    trigger_data JSONB,
    input_data JSONB,
    output_data JSONB,
    current_step VARCHAR(100),
    completed_steps TEXT[],
    failed_steps TEXT[],
    error_message TEXT,
    execution_time_ms INTEGER,
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    
    INDEX idx_workflow_executions_workflow (workflow_id),
    INDEX idx_workflow_executions_status (status),
    INDEX idx_workflow_executions_started (started_at)
);

-- ä»»åŠ¡é˜Ÿåˆ—è¡¨
CREATE TABLE task_queue (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_type VARCHAR(50) NOT NULL,
    task_name VARCHAR(200),
    priority INTEGER DEFAULT 0, -- ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜
    status VARCHAR(20) DEFAULT 'pending', -- pending, processing, completed, failed, cancelled
    payload JSONB NOT NULL,
    result JSONB,
    error_message TEXT,
    retry_count INTEGER DEFAULT 0,
    max_retries INTEGER DEFAULT 3,
    scheduled_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_task_queue_status_priority (status, priority DESC),
    INDEX idx_task_queue_type (task_type),
    INDEX idx_task_queue_scheduled (scheduled_at)
);

-- ç³»ç»Ÿé…ç½®è¡¨
CREATE TABLE system_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value JSONB NOT NULL,
    description TEXT,
    is_encrypted BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_system_configs_key (config_key)
);

-- æ’ä»¶é…ç½®è¡¨
CREATE TABLE plugin_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    plugin_name VARCHAR(100) NOT NULL,
    plugin_type VARCHAR(50) NOT NULL, -- scraper, publisher, analyzer
    version VARCHAR(20),
    config_data JSONB NOT NULL,
    is_enabled BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(plugin_name, plugin_type),
    INDEX idx_plugin_configs_type (plugin_type),
    INDEX idx_plugin_configs_enabled (is_enabled)
);
```

### ç¼“å­˜ç­–ç•¥è®¾è®¡

```javascript
class CacheManager {
  constructor(redisClient) {
    this.redis = redisClient;
    this.defaultTTL = 3600; // 1å°æ—¶
  }

  // å•†å“ç¼“å­˜ç­–ç•¥
  async cacheProduct(product) {
    const key = `product:${product.id}`;
    await this.redis.setex(key, this.defaultTTL, JSON.stringify(product));
    
    // æŒ‰å¹³å°ç¼“å­˜
    const platformKey = `products:${product.source_platform}`;
    await this.redis.sadd(platformKey, product.id);
    await this.redis.expire(platformKey, this.defaultTTL);
  }

  // AIåˆ†æç»“æœç¼“å­˜
  async cacheAnalysis(productId, analysis) {
    const key = `analysis:${productId}`;
    await this.redis.setex(key, 7200, JSON.stringify(analysis)); // 2å°æ—¶
  }

  // ä»·æ ¼æ¯”è¾ƒç¼“å­˜
  async cachePriceComparison(productId, comparison) {
    const key = `price:${productId}`;
    await this.redis.setex(key, 1800, JSON.stringify(comparison)); // 30åˆ†é’Ÿ
  }

  // å·¥ä½œæµæ‰§è¡ŒçŠ¶æ€ç¼“å­˜
  async cacheWorkflowExecution(executionId, execution) {
    const key = `workflow:${executionId}`;
    await this.redis.setex(key, 86400, JSON.stringify(execution)); // 24å°æ—¶
  }

  // æ‰¹é‡å¤±æ•ˆç¼“å­˜
  async invalidateProductCache(productId) {
    const keys = [
      `product:${productId}`,
      `analysis:${productId}`,
      `price:${productId}`
    ];
    
    await this.redis.del(...keys);
  }
}
```

## ğŸ” å®‰å…¨æ¶æ„è®¾è®¡

### è®¤è¯å’Œæˆæƒ

```javascript
class SecurityManager {
  constructor() {
    this.jwtSecret = process.env.JWT_SECRET;
    this.encryptionKey = process.env.ENCRYPTION_KEY;
  }

  // JWT Tokenç”Ÿæˆ
  generateToken(user) {
    const payload = {
      userId: user.id,
      email: user.email,
      roles: user.roles,
      permissions: user.permissions
    };
    
    return jwt.sign(payload, this.jwtSecret, {
      expiresIn: '24h',
      issuer: 'ecommerce-ai-platform'
    });
  }

  // æƒé™éªŒè¯ä¸­é—´ä»¶
  requirePermission(permission) {
    return (req, res, next) => {
      const user = req.user;
      
      if (!user) {
        return res.status(401).json({ error: 'Unauthorized' });
      }
      
      if (!user.permissions.includes(permission)) {
        return res.status(403).json({ error: 'Forbidden' });
      }
      
      next();
    };
  }

  // æ•æ„Ÿæ•°æ®åŠ å¯†
  encrypt(data) {
    const cipher = crypto.createCipher('aes-256-cbc', this.encryptionKey);
    let encrypted = cipher.update(data, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    return encrypted;
  }

  // æ•æ„Ÿæ•°æ®è§£å¯†
  decrypt(encryptedData) {
    const decipher = crypto.createDecipher('aes-256-cbc', this.encryptionKey);
    let decrypted = decipher.update(encryptedData, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    return decrypted;
  }

  // APIé™æµ
  createRateLimiter(windowMs, max) {
    return rateLimit({
      windowMs: windowMs,
      max: max,
      message: 'Too many requests from this IP',
      standardHeaders: true,
      legacyHeaders: false
    });
  }
}
```

### æ•°æ®å®‰å…¨

```javascript
class DataSecurity {
  // æ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨
  static encryptSensitiveFields(data, sensitiveFields) {
    const encrypted = { ...data };
    
    sensitiveFields.forEach(field => {
      if (encrypted[field]) {
        encrypted[field] = SecurityManager.encrypt(encrypted[field]);
      }
    });
    
    return encrypted;
  }

  // æ•°æ®è„±æ•
  static maskSensitiveData(data, maskFields) {
    const masked = { ...data };
    
    maskFields.forEach(field => {
      if (masked[field]) {
        masked[field] = this.maskString(masked[field]);
      }
    });
    
    return masked;
  }

  static maskString(str) {
    if (str.length <= 4) return '***';
    return str.substring(0, 2) + '*'.repeat(str.length - 4) + str.substring(str.length - 2);
  }

  // è¾“å…¥éªŒè¯å’Œæ¸…ç†
  static sanitizeInput(input) {
    if (typeof input === 'string') {
      return input.trim().replace(/<script[^>]*>.*?<\/script>/gi, '');
    }
    return input;
  }
}
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—æ¶æ„

### åº”ç”¨ç›‘æ§

```javascript
class MonitoringService {
  constructor() {
    this.metrics = new Map();
    this.alerts = [];
  }

  // æ€§èƒ½æŒ‡æ ‡æ”¶é›†
  recordMetric(name, value, tags = {}) {
    const metric = {
      name,
      value,
      tags,
      timestamp: Date.now()
    };
    
    this.metrics.set(`${name}_${Date.now()}`, metric);
    
    // å‘é€åˆ°Prometheus
    this.sendToPrometheus(metric);
  }

  // ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
  trackBusinessMetrics() {
    setInterval(async () => {
      // çˆ¬è™«æˆåŠŸç‡
      const scraperSuccessRate = await this.calculateScraperSuccessRate();
      this.recordMetric('scraper_success_rate', scraperSuccessRate);
      
      // AIåˆ†æå‡†ç¡®ç‡
      const aiAccuracy = await this.calculateAIAccuracy();
      this.recordMetric('ai_analysis_accuracy', aiAccuracy);
      
      // å‘å¸ƒæˆåŠŸç‡
      const publishSuccessRate = await this.calculatePublishSuccessRate();
      this.recordMetric('publish_success_rate', publishSuccessRate);
      
      // ç³»ç»Ÿèµ„æºä½¿ç”¨ç‡
      const resourceUsage = await this.getResourceUsage();
      this.recordMetric('cpu_usage', resourceUsage.cpu);
      this.recordMetric('memory_usage', resourceUsage.memory);
      
    }, 60000); // æ¯åˆ†é’Ÿæ”¶é›†ä¸€æ¬¡
  }

  // å‘Šè­¦æ£€æŸ¥
  checkAlerts() {
    setInterval(() => {
      this.alerts.forEach(alert => {
        if (this.evaluateAlertCondition(alert)) {
          this.triggerAlert(alert);
        }
      });
    }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
  }

  // å¥åº·æ£€æŸ¥
  async healthCheck() {
    const checks = {
      database: await this.checkDatabase(),
      redis: await this.checkRedis(),
      plugins: await this.checkPlugins(),
      external_apis: await this.checkExternalAPIs()
    };
    
    const isHealthy = Object.values(checks).every(check => check.status === 'ok');
    
    return {
      status: isHealthy ? 'healthy' : 'unhealthy',
      checks,
      timestamp: new Date().toISOString()
    };
  }
}
```

### ç»“æ„åŒ–æ—¥å¿—

```javascript
class Logger {
  constructor() {
    this.winston = winston.createLogger({
      level: process.env.LOG_LEVEL || 'info',
      format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.errors({ stack: true }),
        winston.format.json()
      ),
      transports: [
        new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
        new winston.transports.File({ filename: 'logs/combined.log' }),
        new winston.transports.Console({
          format: winston.format.simple()
        })
      ]
    });
  }

  // ä¸šåŠ¡æ—¥å¿—
  logScrapingActivity(activity) {
    this.winston.info('Scraping Activity', {
      type: 'scraping',
      platform: activity.platform,
      productsFound: activity.productsFound,
      duration: activity.duration,
      success: activity.success,
      errors: activity.errors
    });
  }

  logAIAnalysis(analysis) {
    this.winston.info('AI Analysis', {
      type: 'ai_analysis',
      productId: analysis.productId,
      score: analysis.score,
      confidence: analysis.confidence,
      processingTime: analysis.processingTime
    });
  }

  logPublishActivity(activity) {
    this.winston.info('Publish Activity', {
      type: 'publishing',
      platform: activity.platform,
      productId: activity.productId,
      status: activity.status,
      platformProductId: activity.platformProductId
    });
  }

  // é”™è¯¯æ—¥å¿—
  logError(error, context = {}) {
    this.winston.error('Application Error', {
      message: error.message,
      stack: error.stack,
      context: context,
      timestamp: new Date().toISOString()
    });
  }

  // æ€§èƒ½æ—¥å¿—
  logPerformance(operation, duration, metadata = {}) {
    this.winston.info('Performance Log', {
      type: 'performance',
      operation: operation,
      duration: duration,
      metadata: metadata
    });
  }
}
```

## ğŸš€ éƒ¨ç½²æ¶æ„

### Dockerå®¹å™¨åŒ–

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    chromium \
    nss \
    freetype \
    freetype-dev \
    harfbuzz \
    ca-certificates \
    ttf-freefont

# è®¾ç½®Puppeteerä½¿ç”¨ç³»ç»ŸChromium
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true \
    PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./
RUN npm ci --only=production

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001
USER nextjs

EXPOSE 3000

CMD ["npm", "start"]
```

### Docker Composeé…ç½®

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://user:password@postgres:5432/ecommerce_ai
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data

  postgres:
    image: postgres:14
    environment:
      - POSTGRES_DB=ecommerce_ai
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app

  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus

  grafana:
    image: grafana/grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana

volumes:
  postgres_data:
  redis_data:
  prometheus_data:
  grafana_data:
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024å¹´12æœˆ  
**ç»´æŠ¤äººå‘˜**: æŠ€æœ¯å›¢é˜Ÿ  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸